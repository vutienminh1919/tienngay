$(document).ajaxStart((function(){$("#loading").show();var t=window.screen.height;$("#loading, .right-col iframe").css("height",t)})).ajaxStop((function(){$("#loading").hide()})),$(document).ready((function(){function t(){this.initData={},this.objJson={},this.report1={},this.report2={},this.report3={},this.current_page=1,this.records_per_page=25,this.selectedIds=[],this.init=function(t,e,a,r){this.initData=t,this.report1=e,this.report2=a,this.report3=r,Object.keys(t).map((function(e){return[Number(e),t[e]]})),this.objJson=t,this.createPanigation(),this.changePage(1),$("#select-all").off().on("click",this.selectAll.bind(this)),$("#export-excel").off().on("click",this.exportExcel.bind(this)),$("#print-data").off().on("click",this.printData.bind(this)),document.getElementById("total").innerHTML=fomatNumber(this.objJson.length),this.generateTab1(),this.generateTab2()},this.selectAll=function(t){var e=[];$(".selected_item").prop("checked",t.target.checked),this.objJson.forEach((function(a,r){a[1].selected=t.target.checked,t.target.checked&&e.push(a[1].id)})),this.selectedIds=e},this.selectItem=function(t){var e=$(t.target).attr("data-no");if(this.objJson[e][1].selected=t.target.checked,t.target.checked&&-1===this.selectedIds.indexOf(this.objJson[e][1].id))this.selectedIds.push(this.objJson[e][1].id);else{var a=this.selectedIds.indexOf(this.objJson[e][1].id);a>-1&&this.selectedIds.splice(a,1)}},this.numPages=function(){return Math.ceil(this.objJson.length/this.records_per_page)},this.prevPage=function(){this.current_page>1&&(this.current_page--,this.changePage(this.current_page))},this.nextPage=function(){this.current_page<this.numPages()&&(this.current_page++,this.changePage(this.current_page))},this.changePageAction=function(t){var e=$(t.target).attr("data-page");this.changePage(e)},this.changePage=function(t){var e=document.getElementById("btn_prev"),a=document.getElementById("btn_next"),r=document.getElementById("listingTable"),n=document.getElementById("page");t<1&&(t=1),t>this.numPages()&&(t=this.numPages()),this.current_page=t,r.innerHTML="";for(var o=(t-1)*this.records_per_page;o<t*this.records_per_page;o++)this.objJson[o]&&(r.innerHTML+=this.createEL(this.objJson[o],o+1,!0));if(n.innerHTML=t+"/"+this.numPages(),1==t?e.classList.add("disabled"):e.classList.remove("disabled"),t==this.numPages()?a.classList.add("disabled"):a.classList.remove("disabled"),$(".page-number.active").removeClass("active"),$("[data-page="+t+"]").parent().addClass("active"),$(".selected_item").on("click",this.selectItem.bind(this)),this.numPages()>10){var s=0,i=0;this.numPages()-Number(t)<Number(5)?s=Number(t)-2*Number(5)+(this.numPages()-Number(t)):(s=Number(t)-Number(5))<1&&(s=1),Number(t)-Number(s)<Number(5)?i=Number(t)+2*Number(5)-(Number(t)-Number(s)):(i=Number(t)+Number(5))>this.numPages()&&(i=this.numPages()),$(".page-number").addClass("hide-item");for(var c=s;c<=i;c++)$("[data-page="+c+"]").parent().removeClass("hide-item"),$("[data-page="+c+"]").text($("[data-page="+c+"]").attr("data-page"));$("[data-page="+Number(s-1)+"]").parent().removeClass("hide-item"),$("[data-page="+Number(s-1)+"]").text("..."),$("[data-page="+Number(i+1)+"]").parent().removeClass("hide-item"),$("[data-page="+Number(i+1)+"]").text("...")}},this.numPages=function(){return Math.ceil(this.objJson.length/this.records_per_page)},this.createPanigation=function(){$("li.page-number").remove();for(var t=1;t<=this.numPages();t++)1==t?$("<li class='page-item page-number active'><a class='page-link' data-page='"+t+"' href='javascript:void(0);'>"+t+"</a></li>").insertBefore("#btn_next"):$("<li class='page-item page-number'><a class='page-link' data-page='"+t+"' href='javascript:void(0);'>"+t+"</a></li>").insertBefore("#btn_next");$("#btn_prev").off().on("click",this.prevPage.bind(this)),$("#btn_next").off().on("click",this.nextPage.bind(this)),$(".pagination").off().on("click",".page-number",this.changePageAction.bind(this))},this.createEL=function(t,e){var a=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"clone-object",n=$("#"+r).find("#clone-item").clone(),o=n.find("td"),s=0,i=n.find("td[data-attr='sum']").length;return $.each(o,(function(e,a){var r=$(o[e]).attr("data-attr");if(r&&"sum"!=r){var n=r.split("."),c=null;if(n.length>1){c=t;for(var d=0;d<n.length;d++){if(!(n[d]in c))return;c=c[n[d]]}}else{if(!(r in t))return;c=t[r]}if(!isNaN(c)&&i&&(s+=parseFloat(c)),$(o[e]).attr("format-number"))_numberFormated=fomatNumber(c),$(o[e]).text(_numberFormated);else if($(o[e]).attr("zero-before")&&c)$(o[e]).text("'"+c);else if($(o[e]).attr("timestamp")){var l=timestampToDate(c);$(o[e]).text(l)}else if($(o[e]).attr("func")){var u=window[$(o[e]).attr("func")](c);$(o[e]).text(u)}else $(o[e]).text(c)}})),i&&n.find("td[data-attr='sum']").text(s),a?n.find("#transaction_no").text(e):n.find("#selected_item").attr("data-no",e),n.find("#details-show-info__id__").attr("data-id",t.id),n.find("#details-show-info__id__").attr("href","tran-detail/"+t.id),t.selected?n.find("#selected_item").attr("checked",!0):n.find("#selected_item").attr("checked",!1),n.html()},this.exportExcel=function(t){t.preventDefault();for(var e=$(t.target).attr("file-name"),a=$(t.target).attr("clone-table"),r="",n=1,o=0;o<this.objJson.length;o++)r+="<tr>"+this.createEL(this.objJson[o],n,!0,a)+"</tr>",n++;var s=document.getElementById(a).cloneNode(!0);s.querySelector("#table-rows").innerHTML=r;var i=$(t.target).attr("report-table1"),c=document.getElementById(i).cloneNode(!0),d=c.caption.innerHTML,l=$(t.target).attr("report-table2"),u=document.getElementById(l).cloneNode(!0),h=u.caption.innerHTML,m=$(t.target).attr("report-table3"),g=document.getElementById(m).cloneNode(!0),p=g.caption.innerHTML,f=XLSX.utils.table_to_sheet(s),_=XLSX.utils.table_to_sheet(c),b=XLSX.utils.table_to_sheet(u),v=XLSX.utils.table_to_sheet(g),w=XLSX.utils.book_new(),x=XLSX.utils.sheet_to_json(_,{header:1}),L=XLSX.utils.sheet_to_json(b,{header:1}),N=XLSX.utils.sheet_to_json(v,{header:1});L=[[h]].concat(L).concat([""]).concat([[p]]).concat(N),x=[[d]].concat(x);var j=XLSX.utils.json_to_sheet(L,{skipHeader:!0}),y=XLSX.utils.json_to_sheet(x,{skipHeader:!0});return XLSX.utils.book_append_sheet(w,f,"Form thông tin"),XLSX.utils.book_append_sheet(w,j,"Tổng hợp 1"),XLSX.utils.book_append_sheet(w,y,"Tổng hợp 2"),XLSX.writeFile(w,e+".xlsx")},this.generateTab1=function(){console.log("generateTab1"),console.log(this.report2);var t=document.getElementById("report-object2"),e={},a=$("#"+t.id).find("#clone-item").clone(),r=a.find("td");$.each(r,(function(t,a){var n=$(r[t]).attr("data-attr"),o=$(r[t]).attr("total-column");n&&o&&(e[n]=0)})),_rows="",count=1;for(var n=0;n<this.report2.length;n++){var o=this.createEL(this.report2[n],count,!0,t.id);_rows+="<tr>"+o+"</tr>",count++,$.each($(o),(function(t,a){var r=$(a).attr("data-attr"),n=$(a).text(),o=!isNaN(n);r&&o&&(e[r]+=parseFloat(n))}))}_rows+="<tr>";var s=!0;$.each(r,(function(t,a){if(s)return _rows+="<td>Tổng</td>",s=!1,!0;_rows+="<td>";var n=$(r[t]).attr("data-attr"),o=$(r[t]).attr("total-column");n&&o&&"avg_request_delay_time"!=n&&"avg_resend_request_time"!=n&&"avg_request_delay_time_tat_toan"!=n&&"avg_request_delay_time_mien_giam"!=n&&"avg_request_delay_time_gia_han_co_cau"!=n?(_value=Math.round(100*e[n])/100,_rows+=_value):_rows+="",_rows+="</td>"})),_rows+="</tr>",t.querySelector("#table-rows").innerHTML=_rows;var i=document.getElementById("report-object3");e={},a=$("#"+i.id).find("#clone-item").clone(),r=a.find("td"),$.each(r,(function(t,a){var n=$(r[t]).attr("data-attr"),o=$(r[t]).attr("total-column");n&&o&&(e[n]=0)})),_rows="",count=1;for(var c=0;c<this.report3.length;c++){var d=this.createEL(this.report3[c],count,!0,i.id);_rows+="<tr>"+d+"</tr>",count++,$.each($(d),(function(t,a){var r=$(a).attr("data-attr"),n=$(a).text(),o=!isNaN(n);r&&o&&(e[r]+=parseFloat(n))}))}_rows+="<tr>",s=!0,$.each(r,(function(t,a){if(s)return _rows+="<td>Tổng</td>",s=!1,!0;_rows+="<td>";var n=$(r[t]).attr("data-attr"),o=$(r[t]).attr("total-column");n&&o?(_value=Math.round(100*e[n])/100,_rows+=_value):_rows+="",_rows+="</td>"})),_rows+="</tr>",i.querySelector("#table-rows").innerHTML=_rows},this.generateTab2=function(){var t=document.getElementById("report-object1");_rows="",count=1;var e={},a=$("#"+t.id).find("#clone-item").clone().find("td");$.each(a,(function(t,r){var n=$(a[t]).attr("data-attr"),o=$(a[t]).attr("total-column");n&&o&&(e[n]=0)}));for(var r=0;r<this.report1.length;r++){var n=this.createEL(this.report1[r],count,!0,t.id);_rows+="<tr>"+n+"</tr>",count++,$.each($(n),(function(t,a){var r=$(a).attr("data-attr"),n=$(a).text(),o=!isNaN(n);r&&o&&(e[r]+=parseFloat(n))}))}_rows+="<tr>";var o=!0;$.each(a,(function(t,r){if(o)return _rows+="<td>Tổng</td>",o=!1,!0;_rows+="<td>";var n=$(a[t]).attr("data-attr"),s=$(a[t]).attr("total-column");n&&s?(_value=Math.round(100*e[n])/100,_rows+=_value):_rows+="",_rows+="</td>"})),_rows+="</tr>",t.querySelector("#table-rows").innerHTML=_rows},this.printData=function(t){t.preventDefault();for(var e=$(t.target).attr("clone-table"),a="",r=1,n=0;n<this.objJson.length;n++)this.objJson[n][1].selected&&(a+="<tr>"+this.createEL(this.objJson[n][1],r,!0)+"</tr>",r++);var o=$("#"+e).clone();o.find("#table-rows").html($.parseHTML(a)),o.removeAttr("hidden"),o.find("th:last-child, td:last-child").hide();var s=window.open();s.document.write(o.prop("outerHTML")),s.print(),s.close()},fomatNumber=function(t){return(t=parseInt(t))>0||t<0?t.toLocaleString("en-US"):0},timestampToDate=function(t){return(t=parseInt(t))>0?new Date(1e3*t).toLocaleDateString("vi-VN"):""}}var e=new t,a=$('[name="_token"]').val();function r(a,r,n,o){e&&(e=null),(e=new t).init(a,r,n,o)}r(transactions,report1,report2,report3),$("#select-time").datepicker({format:"yyyy-mm",startView:"months",minViewMode:"months",autoclose:!0}).on("change",(function(t){var e={time:$("#select-time").val(),_token:a};$.ajax({type:"POST",url:getListByMonthUrl,data:e,success:function(t){console.log(t),200==t.status?(console.log(t.data),transactions=t.data.data,r(transactions),$("#total_transaction").text(t.data.totalTransaction),$("#total_paid_amount").text(t.data.totalAmount)):($("#errorModal").find(".msg_error").text(t.message),$("#errorModal").show())},error:function(t,e){0===t.status||404==t.status||500==t.status||"parsererror"===e||"timeout"===e||"abort"===e||t.responseText,$("#errorModal").show()}})})),$("#submit-data").on("click",(function(t){t.preventDefault(),$("#submit-data").prop("disabled",!0);var e=$("#search-form");e.find("input:text").each((function(){$(this).val($.trim($(this).val()))}));var a=e.attr("action");$.ajax({type:"POST",url:a,data:e.serialize(),success:function(t){var e=new bootstrap.Modal(document.getElementById("errorModal"));if($.isEmptyObject(t))$("#errorModal").find(".msg_error").text("Có lỗi xảy ra trong quá trình tìm kiếm"),e.show();else if(200==t.status){console.log(t.data),transactions=t.data.result;var a=t.data.report1,n=t.data.report2,o=t.data.report3;r(transactions,a,n,o)}else $("#errorModal").find(".msg_error").text(t.message),e.show();$("#submit-data").prop("disabled",!1),$("#fillter-content").hide()},error:function(t,e){var a="";a=0===t.status?"Not connect.\n Verify Network.":404==t.status?"Requested page not found. [404]":500==t.status?"Internal Server Error [500].":"parsererror"===e?"Requested JSON parse failed.":"timeout"===e?"Time out error.":"abort"===e?"Ajax request aborted.":"Uncaught Error.\n"+t.responseText,$("#submit-data").prop("disabled",!1),$("#errorModal").find(".msg_error").text(a),$("#errorModal").show()}})})),$("#search-input").on("change",(function(t){t.preventDefault();var e=$("#search-input").val();console.log(e);var a=new RegExp(e,"g"),n=[];e?transactions.forEach((function(t,e){null!==JSON.stringify(t).match(a)&&n.push(t)})):n=transactions,r(n)}))}));